-- Test debug logging for text types (lines 1959-1970)
SET client_min_messages = warning;
CREATE EXTENSION IF NOT EXISTS smol;
-- Enable debug logging (but disable profiling for deterministic output)
SET smol.debug_log = on;
SET smol.profile = off;
SET client_min_messages = debug1;
-- Create table with text key and text INCLUDE
DROP TABLE IF EXISTS t_debug CASCADE;
DEBUG:  relation "t_debug" does not exist
NOTICE:  table "t_debug" does not exist, skipping
SET client_min_messages = warning;  -- Suppress OID messages
CREATE UNLOGGED TABLE t_debug(k text COLLATE "C", v text COLLATE "C", i int4);
SET client_min_messages = debug1;
INSERT INTO t_debug VALUES
    ('key001', 'value001', 1),
    ('key002', 'value002', 2),
    ('key003', 'value003', 3);
-- Create SMOL index with text INCLUDE columns
-- Temporarily disable debug logging to avoid non-deterministic OIDs/timing in output
SET smol.debug_log = off;
SET client_min_messages = warning;
CREATE INDEX t_debug_smol ON t_debug USING smol(k) INCLUDE (v, i);
ANALYZE t_debug;
-- Re-enable debug logging for the actual test queries
SET smol.debug_log = on;
SET client_min_messages = debug1;
SET enable_seqscan = off;
SET enable_bitmapscan = off;
SET enable_indexscan = off;
SET enable_indexonlyscan = on;
-- Query to trigger debug logging of varlena sizes
-- The debug log will show varlena sizes and scan behavior, but
-- we've disabled logging during CREATE INDEX to avoid non-deterministic OIDs/timing
SELECT k, v, i FROM t_debug WHERE k >= 'key002';
LOG:  [smol] smol_handler:1093: enter smol_handler
LOG:  [smol] smol_handler:1093: enter smol_handler
LOG:  [smol] smol_meta_read:3580: meta: magic=0x534d4f4c ver=1 nkeyatts=1 len1=32 len2=0 root=1 h=1
LOG:  [smol] smol_beginscan:1836: beginscan nkeys=1 key_len=32
LOG:  [smol] smol_meta_read:3580: meta: magic=0x534d4f4c ver=1 nkeyatts=1 len1=32 len2=0 root=1 h=1
LOG:  [smol] smol_beginscan:1894: beginscan layout: key_len=32 two_col=0 ninclude=2 sz=64
LOG:  [smol] smol_beginscan:1896: include[0]: len=8 align=i off=36 is_text=1
LOG:  [smol] smol_beginscan:1896: include[1]: len=4 align=i off=48 is_text=0
LOG:  [smol] smol_meta_read:3580: meta: magic=0x534d4f4c ver=1 nkeyatts=1 len1=32 len2=0 root=1 h=1
LOG:  [smol] smol_find_first_leaf:4448: find_first_leaf: leaf=1 for bound=0 height=1
LOG:  [smol] smol_gettuple:2280: gettuple init cur_blk=1
LOG:  [smol] smol_gettuple:2310: seeked (binsearch) within leaf off=2
LOG:  [smol] smol_gettuple:2836: tuple key varlena size=10
LOG:  [smol] smol_gettuple:2836: tuple key varlena size=10
LOG:  [smol] smol_gettuple:3285: advance to right leaf blk=4294967295
LOG:  [smol] smol_endscan:3295: end scan
   k    |    v     | i 
--------+----------+---
 key002 | value002 | 2
 key003 | value002 | 3
(2 rows)

-- Reset
SET smol.debug_log = off;
SET client_min_messages = warning;
DROP TABLE t_debug CASCADE;
